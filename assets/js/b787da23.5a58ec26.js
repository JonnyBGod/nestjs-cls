"use strict";(self.webpackChunknestjs_cls_docs=self.webpackChunknestjs_cls_docs||[]).push([[126],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),m=a,h=u["".concat(s,".").concat(m)]||u[m]||d[m]||i;return n?r.createElement(h,o(o({ref:t},c),{},{components:n})):r.createElement(h,o({ref:t},c))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:a,o[1]=l;for(var p=2;p<i;p++)o[p]=n[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},8198:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var r=n(7462),a=(n(7294),n(3905));const i={},o="Compatibility",l={unversionedId:"considerations/compatibility",id:"considerations/compatibility",title:"Compatibility",description:"The table below outlines the compatibility with some platforms:",source:"@site/docs/05_considerations/02_compatibility.md",sourceDirName:"05_considerations",slug:"/considerations/compatibility",permalink:"/nestjs-cls/considerations/compatibility",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/05_considerations/02_compatibility.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{},sidebar:"documentationSidebar",previous:{title:"Security",permalink:"/nestjs-cls/considerations/security"},next:{title:"Migration guide",permalink:"/nestjs-cls/migration-guide/"}},s={},p=[{value:"REST",id:"rest",level:2},{value:"GraphQL",id:"graphql",level:2},{value:"<code>@nestjs/graphql &gt;= 10</code>",id:"nestjsgraphql--10",level:3},{value:"<code>@nestjs/graphql &lt; 10</code>",id:"nestjsgraphql--10-1",level:3},{value:"Others",id:"others",level:2},{value:"Websockets",id:"websockets",level:3}],c={toc:p},u="wrapper";function d(e){let{components:t,...n}=e;return(0,a.kt)(u,(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"compatibility"},"Compatibility"),(0,a.kt)("p",null,"The table below outlines the compatibility with some platforms:"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:"center"}),(0,a.kt)("th",{parentName:"tr",align:"center"},"REST"),(0,a.kt)("th",{parentName:"tr",align:"center"},"GQL"),(0,a.kt)("th",{parentName:"tr",align:"center"},"WS"),(0,a.kt)("th",{parentName:"tr",align:"center"},"Microservices"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},(0,a.kt)("strong",{parentName:"td"},"ClsMiddleware")),(0,a.kt)("td",{parentName:"tr",align:"center"},"\u2714"),(0,a.kt)("td",{parentName:"tr",align:"center"},"\u2714"),(0,a.kt)("td",{parentName:"tr",align:"center"},"\u2716"),(0,a.kt)("td",{parentName:"tr",align:"center"},"\u2716")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},(0,a.kt)("strong",{parentName:"td"},"ClsGuard")," ",(0,a.kt)("br",null),"(uses ",(0,a.kt)("inlineCode",{parentName:"td"},"enterWith"),")"),(0,a.kt)("td",{parentName:"tr",align:"center"},"\u2714"),(0,a.kt)("td",{parentName:"tr",align:"center"},"\u2714"),(0,a.kt)("td",{parentName:"tr",align:"center"},"\u2714",(0,a.kt)("a",{parentName:"td",href:"#websockets"},"*")),(0,a.kt)("td",{parentName:"tr",align:"center"},"\u2714")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:"center"},(0,a.kt)("strong",{parentName:"td"},"ClsInterceptor")," ",(0,a.kt)("br",null),"(context inaccessible",(0,a.kt)("br",null),"in ",(0,a.kt)("em",{parentName:"td"},"Guards"),")"),(0,a.kt)("td",{parentName:"tr",align:"center"},"\u2714",(0,a.kt)("br",null),"context also inaccessible",(0,a.kt)("br",null),"in ",(0,a.kt)("em",{parentName:"td"},"Exception Filters")),(0,a.kt)("td",{parentName:"tr",align:"center"},"\u2714"),(0,a.kt)("td",{parentName:"tr",align:"center"},"\u2714",(0,a.kt)("a",{parentName:"td",href:"#websockets"},"*")),(0,a.kt)("td",{parentName:"tr",align:"center"},"\u2714")))),(0,a.kt)("h2",{id:"rest"},"REST"),(0,a.kt)("p",null,"This package is compatible with Nest-supported REST controllers and the preferred way is to use the ",(0,a.kt)("inlineCode",{parentName:"p"},"ClsMiddleware")," with the ",(0,a.kt)("inlineCode",{parentName:"p"},"mount")," option set to ",(0,a.kt)("inlineCode",{parentName:"p"},"true"),"."),(0,a.kt)("p",null,"Tested with:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u2714 Express"),(0,a.kt)("li",{parentName:"ul"},"\u2714 Fastify")),(0,a.kt)("p",null,"Known issues:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"In case API versioning is used, the automatic mounting of the ",(0,a.kt)("inlineCode",{parentName:"li"},"ClsMiddleware")," does not work and it needs to be mounted manually. See issue ",(0,a.kt)("a",{parentName:"li",href:"https://github.com/Papooch/nestjs-cls/issues/67"},"#67")," for details."),(0,a.kt)("li",{parentName:"ul"},"Some existing Express middlewares may cause context loss, if that happens, mount the ",(0,a.kt)("inlineCode",{parentName:"li"},"ClsMiddleware")," manually ",(0,a.kt)("em",{parentName:"li"},"after")," those offending ones (",(0,a.kt)("a",{parentName:"li",href:"https://github.com/Papooch/nestjs-cls/issues/50#issuecomment-1368162870"},"#50"),")")),(0,a.kt)("h2",{id:"graphql"},"GraphQL"),(0,a.kt)("p",null,"Using an interceptor or a guard may result in that enhancer triggering multiple times in case there are multiple queries in the GQL request."),(0,a.kt)("p",null,"Due to this, you should ensure that any operation on the CLS store within enhancers is ",(0,a.kt)("em",{parentName:"p"},"idempotent"),". This includes the ",(0,a.kt)("inlineCode",{parentName:"p"},"setup")," function. Therefore, it is advised to use the ",(0,a.kt)("inlineCode",{parentName:"p"},"ClsService#setIfUndefined()")," method."),(0,a.kt)("p",null,"Tested with:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u2714 Apollo (Express)"),(0,a.kt)("li",{parentName:"ul"},"\u2714 Mercurius (Fastify)")),(0,a.kt)("h3",{id:"nestjsgraphql--10"},(0,a.kt)("inlineCode",{parentName:"h3"},"@nestjs/graphql >= 10")),(0,a.kt)("p",null,"Since v10, Nest's GraphQL resolvers are compatible with this package and the preferred way to initialize the CLS context is use the ",(0,a.kt)("inlineCode",{parentName:"p"},"ClsMiddleware")," with the ",(0,a.kt)("inlineCode",{parentName:"p"},"mount")," option."),(0,a.kt)("h3",{id:"nestjsgraphql--10-1"},(0,a.kt)("inlineCode",{parentName:"h3"},"@nestjs/graphql < 10")),(0,a.kt)("p",null,"For older versions of graphql, the ",(0,a.kt)("inlineCode",{parentName:"p"},"ClsMiddleware")," needs to be ",(0,a.kt)("a",{parentName:"p",href:"/nestjs-cls/setting-up-cls-context/using-a-middleware#manually"},"mounted manually")," with ",(0,a.kt)("inlineCode",{parentName:"p"},"app.use(...)")," in order to correctly set up the context for resolvers. Additionally, you have to pass ",(0,a.kt)("inlineCode",{parentName:"p"},"useEnterWith: true")," to the ",(0,a.kt)("inlineCode",{parentName:"p"},"ClsMiddleware")," options, because the context gets lost otherwise due to ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/apollographql/apollo-server/issues/2042"},"an issue with CLS and Apollo")," (sadly, the same is true for ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/Papooch/nestjs-cls/issues/1"},"Mercurius"),"). This method is functionally identical to just using the ",(0,a.kt)("inlineCode",{parentName:"p"},"ClsGuard"),"."),(0,a.kt)("p",null,"Alternatively, you can use the ",(0,a.kt)("inlineCode",{parentName:"p"},"ClsInterceptor"),", which uses the safer ",(0,a.kt)("inlineCode",{parentName:"p"},"AsyncLocalStorage#run")," (thanks to ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/Papooch/nestjs-cls/issues/5"},"andreialecu"),"), but remember that using it makes CLS unavailable in ",(0,a.kt)("em",{parentName:"p"},"Guards"),"."),(0,a.kt)("h2",{id:"others"},"Others"),(0,a.kt)("p",null,"Use the ",(0,a.kt)("inlineCode",{parentName:"p"},"ClsGuard")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"ClsInterceptor")," to set up context with any other platform."),(0,a.kt)("p",null,"There are no explicit test for other transports, so I can't guarantee it will work with your platform of choice, but there's nothing that would indicate otherwise."),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"If you decide to try this package with a platform that is not listed here, ",(0,a.kt)("strong",{parentName:"p"},"please let me know")," so I can add the compatibility notice.")),(0,a.kt)("p",null,"Below are listed transports with which it is confirmed to work:"),(0,a.kt)("h3",{id:"websockets"},"Websockets"),(0,a.kt)("p",null,(0,a.kt)("em",{parentName:"p"},"Websocket Gateways")," don't respect globally bound enhancers, therefore it is required to bind the ",(0,a.kt)("inlineCode",{parentName:"p"},"ClsGuard")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"ClsInterceptor")," manually on the ",(0,a.kt)("inlineCode",{parentName:"p"},"WebsocketGateway"),". Special care is also needed for the ",(0,a.kt)("inlineCode",{parentName:"p"},"handleConnection")," method (See ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/Papooch/nestjs-cls/issues/8"},"#8"),")"))}d.isMDXComponent=!0}}]);